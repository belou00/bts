<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Renouvellement – Belougas Ticketing System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- chemin relatif pour marcher avec /bts/s/renew → /bts/styles/renew.css -->
  <link rel="stylesheet" href="../styles/renew.css">
</head>
<body>
  <header>
    <h1>Renouvellement d’abonnement</h1>
    <div class="sub" id="headerSub">Chargement…</div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <h3>Plan du lieu</h3>
        <div id="planWrap">
          <p id="noPlan" class="empty">Plan indisponible pour cette saison.</p>
          <object id="venuePlan" type="image/svg+xml" data="" hidden></object>
        </div>
      </section>

      <section class="card">
        <h3>Vos sièges (groupe)</h3>
        <div id="seatsList" class="list"></div>

        <div class="tariff">
          <div class="flex">
            <div>
              <label for="installments">Paiement en</label>
              <select id="installments">
                <option value="1">1 fois</option>
                <option value="2">2 fois</option>
                <option value="3">3 fois</option>
              </select>
            </div>
            <div>
              <label for="payerEmail">Email du payeur</label>
              <input id="payerEmail" type="email" placeholder="prenom.nom@example.com" autocomplete="email">
            </div>
          </div>
          <p class="muted">Les tarifs se choisissent <em>par siège</em>. Une justification peut être demandée pour les tarifs réduits.</p>
        </div>

        <div class="btnbar">
          <button class="secondary" id="btnRefresh">Rafraîchir</button>
          <button id="btnCheckout">Payer via HelloAsso</button>
        </div>
        <div id="msg" class="msg"></div>
      </section>
    </div>
  </main>

<script>
(async function(){
  const $ = (sel, el=document) => el.querySelector(sel);
  const ui = {
    headerSub: $('#headerSub'),
    plan: $('#venuePlan'),
    noPlan: $('#noPlan'),
    list: $('#seatsList'),
    msg: $('#msg'),
    installments: $('#installments'),
    payerEmail: $('#payerEmail'),
    btnCheckout: $('#btnCheckout'),
    btnRefresh: $('#btnRefresh')
  };
  const pageUrl = new URL(window.location.href);

  async function loadData() {
    const r = await fetch(pageUrl.toString(), { headers: { 'Accept': 'application/json' } });
    if (!r.ok) {
      const t = await r.text().catch(()=> '');
      throw new Error(`Erreur ${r.status}: ${t.slice(0,200)}`);
    }
    return r.json();
  }

  // ==== HIGHLIGHT DANS LE SVG ====
  let svgDoc = null;
  function getSvgDoc() {
    try { return ui.plan.contentDocument || ui.plan.getSVGDocument?.() || null; }
    catch { return null; }
  }
  // Injecte les styles .bts-hl dans le document SVG (indispensable)
  function injectSvgStyles() {
    if (!svgDoc) return;
    const id = 'bts-svg-style';
    if (svgDoc.getElementById(id)) return;
    const css = `
@keyframes bts-pulse {
  0% { filter: drop-shadow(0 0 0 rgba(70,130,255,.0)); }
  50% { filter: drop-shadow(0 0 6px rgba(70,130,255,.65)); }
  100% { filter: drop-shadow(0 0 0 rgba(70,130,255,.0)); }
}
.bts-hl {
  stroke:#4ea0ff !important;
  stroke-width:2 !important;
  fill:rgba(78,160,255,.18) !important;
  vector-effect:non-scaling-stroke;
  animation:bts-pulse 1.8s infinite;
}
.bts-hl-hover {
  stroke:#4ea0ff !important;
  stroke-width:2 !important;
  fill:rgba(78,160,255,.12) !important;
  vector-effect:non-scaling-stroke;
}`;
    const style = svgDoc.createElementNS('http://www.w3.org/2000/svg','style');
    style.setAttribute('id', id);
    style.textContent = css;
    (svgDoc.querySelector('svg') || svgDoc).appendChild(style);
  }

  function seatSelectors(seatId) {
    const sid = String(seatId || '').trim();
    if (!sid) return [];
    return [
      `#${CSS.escape(sid)}`,
      `[data-seat-id="${sid}"]`,
      `[data-id="${sid}"]`
    ];
  }
  function findSeatElements(seatId) {
    if (!svgDoc) return [];
    const sels = seatSelectors(seatId);
    for (const s of sels) {
      const n = [...svgDoc.querySelectorAll(s)];
      if (n.length) return n;
    }
    return [];
  }
  function highlightSeat(seatId, on=true, hover=false) {
    const list = findSeatElements(seatId);
    for (const el of list) {
      el.classList.toggle('bts-hl', on && !hover);
      el.classList.toggle('bts-hl-hover', on && hover);
    }
  }

  function seatRowTpl(s, idx) {
    const disabled = !s.exists || s.status === 'missing' || s.status === 'booked';
    const checked = s.provisioned && !disabled;
    const statusHtml = !s.exists
      ? '<span class="status err">Inexistant (saison)</span>'
      : (s.status === 'provisioned'
          ? '<span class="status ok">Provisionné</span>'
          : s.status === 'available'
            ? '<span class="status">Disponible</span>'
            : `<span class="status warn">${s.status}</span>`);
    const tariffId = `tariff_${idx}`;
    const justId = `just_${idx}`;
    const cbId = `cb_${idx}`;
    return `
      <div class="row ${!s.exists?'missing':''}" data-seat="${s.seatId}">
        <div>
          <input type="checkbox" id="${cbId}" ${checked && !disabled ? 'checked':''} ${disabled?'disabled':''} />
        </div>
        <div>
          <div class="seatId">${s.seatId}</div>
          <div class="muted">${s.ownerEmail ? ('Titulaire N-1: '+s.ownerEmail) : ''} ${statusHtml}</div>
        </div>
        <div class="tariffCell">
          <label class="muted" for="${tariffId}">Tarif</label>
          <select id="${tariffId}" ${disabled?'disabled':''}>
            <option value="ADULT">Adulte</option>
            <option value="TEEN_12_18">12–18 ans</option>
            <option value="CHILD">Enfant</option>
            <option value="REDUCED">Réduit</option>
          </select>
        </div>
        <div class="justifCell">
          <label class="muted" for="${justId}">Justification (si réduit)</label>
          <input type="text" id="${justId}" placeholder="ex: justificatif étudiant, etc." ${disabled?'disabled':''} />
        </div>
      </div>
    `;
  }

  function gatherLines(container) {
    const rows = [...container.querySelectorAll('.row')];
    const out = [];
    rows.forEach((row, i) => {
      const seatId = row.getAttribute('data-seat');
      const checked = row.querySelector(`#cb_${i}`)?.checked;
      const tariff = row.querySelector(`#tariff_${i}`)?.value || 'ADULT';
      const just   = row.querySelector(`#just_${i}`)?.value?.trim() || '';
      if (checked) out.push({ seatId, tariffCode: tariff, justification: just });
    });
    return out;
  }
  function setMsg(text, ok=false) {
    ui.msg.textContent = text;
    ui.msg.className = 'msg ' + (ok ? 'ok' : 'err');
  }

  try {
    const data = await loadData();
    if (data.error) throw new Error(data.error);

    ui.headerSub.textContent = `Saison ${data.seasonCode} — Groupe ${data.groupKey}`;

    if (data.venuePlanUrl) {
      ui.plan.data = data.venuePlanUrl;
      ui.plan.hidden = false;
      ui.noPlan?.remove();
      ui.plan.addEventListener('load', () => {
        svgDoc = getSvgDoc();
        if (!svgDoc) return;
        injectSvgStyles(); // <<<<<< INJECTION CSS DANS LE SVG

        // Highlight initial: sièges provisionnés cochés
        const rows = [...ui.list.querySelectorAll('.row input[type="checkbox"]:checked')].map(cb => cb.closest('.row'));
        rows.forEach(r => highlightSeat(r.getAttribute('data-seat'), true, false));
        // Focus éventuel
        if (data.prefSeatId) highlightSeat(data.prefSeatId, true, false);
      }, { once:true });
    }

    if (Array.isArray(data.members) && data.members.length) {
      ui.payerEmail.value = data.members[0].email || '';
    }

    if (!data.seats || !data.seats.length) {
      ui.list.innerHTML = '<p class="empty">Aucun siège lié à ce groupe pour cette saison.</p>';
    } else {
      ui.list.innerHTML = data.seats.map((s, idx) => seatRowTpl(s, idx)).join('');

      // Interactions: hover/click → highlight
      [...ui.list.querySelectorAll('.row')].forEach((row, i) => {
        const sid = row.getAttribute('data-seat');
        const cb = row.querySelector(`#cb_${i}`);
        row.addEventListener('mouseenter', () => highlightSeat(sid, true, true));
        row.addEventListener('mouseleave', () => highlightSeat(sid, false, true));
        if (cb) cb.addEventListener('change', () => highlightSeat(sid, cb.checked, false));
      });

      if (data.prefSeatId) {
        const el = ui.list.querySelector(`.row[data-seat="${CSS.escape(data.prefSeatId)}"]`);
        if (el) { el.style.outline = '2px solid #4ea0ff'; el.scrollIntoView({ behavior:'smooth', block:'center' }); }
      }
    }

    ui.btnRefresh.addEventListener('click', () => location.reload());

    ui.btnCheckout.addEventListener('click', async () => {
      ui.msg.textContent = '';
      const lines = gatherLines(ui.list);
      if (!lines.length) return setMsg('Sélectionnez au moins un siège provisionné à renouveler.');
      const payerEmail = ui.payerEmail.value.trim();
      if (!payerEmail) return setMsg('Renseignez un email du payeur.');
      const installments = Number(ui.installments.value || 1);

      ui.btnCheckout.disabled = true;
      ui.btnCheckout.textContent = 'Création du paiement…';
      try {
        const r = await fetch(pageUrl.toString(), {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ lines, installments, payer:{ email: payerEmail } })
        });
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) { throw new Error(j && j.error ? j.error : `HTTP ${r.status}`); }
        if (!j.checkoutUrl) throw new Error('checkoutUrl manquant');
        window.location.href = j.checkoutUrl;
      } catch (e) {
        setMsg(`Échec: ${e.message || e}`);
      } finally {
        ui.btnCheckout.disabled = false;
        ui.btnCheckout.textContent = 'Payer via HelloAsso';
      }
    });

  } catch (e) {
    setMsg(`Impossible de charger vos données de renouvellement. (${e.message || e})`);
  }
})();
</script>
</body>
</html>
