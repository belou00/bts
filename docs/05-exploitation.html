<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTS – Guide d’exploitation (Phase 1)</title>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#0b1020;color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:24px}
header{position:sticky;top:0;background:rgba(17,24,39,.9);border-bottom:1px solid var(--border);backdrop-filter:saturate(140%) blur(6px);}
header .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 24px}
header img{height:38px}
h1{font-size:28px;margin:18px 0 8px}
h2{font-size:22px;margin:20px 0 8px}
h3{font-size:18px;margin:18px 0 6px}
p{margin:8px 0}
ul{margin:6px 0 12px 22px}
code,kbd,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
pre{background:#0b1020;border:1px solid var(--border);border-radius:8px;padding:12px;overflow:auto;white-space:pre}
table{width:100%;border-collapse:collapse;margin:10px 0 16px}
th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
.small{color:var(--muted);font-size:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;margin:16px 0}
footer{border-top:1px solid var(--border);margin-top:24px;padding:16px 24px;color:var(--muted)}
.toc{background:#0b1020;border:1px solid var(--border);border-radius:12px;padding:12px}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
</style>
</head>
<body>
<header><div class="inner">
  <img src="logo.png" alt="Belougas" />
  <div>
    <div class="small">BelougasTicketingSystem · Phase 1 · 2025-08-17</div>
    <strong>BTS – Guide d’exploitation (Phase 1)</strong>
  </div>
</div></header>
<main class="container">

<div class="card"><h1>Guide d’exploitation</h1></div>

<h2>1. Opérations courantes</h2>
<ul>
  <li>Status/logs : <code>pm2 status</code>, <code>pm2 logs bts-int|bts-prod</code></li>
  <li>Santé : <code>GET /bts/health</code></li>
  <li>Déploiement : INT → <code>reset origin/int</code> ; PROD → <code>reset origin/main</code> + <code>npm ci</code> + <code>pm2 restart</code></li>
  <li>Backups Mongo : <code>mongodump --db bts_prod</code></li>
</ul>

<h2>2. Démarrer une nouvelle saison</h2>
<ol>
  <li>Créer la <strong>saison</strong> (<code>Season</code> : code, name, venueSlug, phases).</li>
  <li>Importer <strong>catalogue</strong> de tarifs (tarifs génériques).</li>
  <li>Importer <strong>prix par zone</strong> (saison/venue).</li>
  <li>Importer <strong>subscribers_flat</strong> (1 ligne = 1 siège).</li>
  <li><strong>Provisionner</strong> les sièges N-1.</li>
  <li>Exporter <strong>liens renew</strong> par groupe et envoyer invitations.</li>
</ol>

<h2>3. Commandes (INT exemple)</h2>
<h3>3.1 Catalogue de tarifs (import)</h3>
<pre><code>node -r dotenv/config scripts/tariffs/import-catalog.js data/tariff_catalog.csv \
  dotenv_config_path=.env.int
# Attendu: "Imported &lt;n&gt; tariffs" / diff si mise à jour
</code></pre>

<h3>3.2 Prix par zone (import)</h3>
<pre><code>node -r dotenv/config scripts/pricing/import-zone-tariffs.js 2025-2026 patinoire-blagnac \
  data/prices_patinoire-blagnac.csv dotenv_config_path=.env.int
# Attendu: "Upserted &lt;n&gt; zone prices"
</code></pre>

<h3>3.3 Abonnés (flat, 1 ligne = 1 siège)</h3>
<pre><code>node -r dotenv/config scripts/import-subscribers-flat.js data/subscribers_flat.csv 2025-2026 \
  --venue=patinoire-blagnac dotenv_config_path=.env.int
# Attendu: "Imported &lt;n&gt; subscriber seat lines"
</code></pre>

<h3>3.4 Provision des sièges N-1</h3>
<pre><code>node -r dotenv/config scripts/renewal/provision-seats.js 2025-2026 \
  --venue=patinoire-blagnac --apply dotenv_config_path=.env.int
# Attendu: "scanned=&lt;n&gt; provisioned=&lt;m&gt; ..."
</code></pre>

<h3>3.5 Export des liens renew (groupes)</h3>
<pre><code>node -r dotenv/config scripts/export-renew-groups.js 2025-2026 \
  --base=https://billetterie-dev.belougas.fr/bts --out=renew-groups-int.csv \
  dotenv_config_path=.env.int
# Fichier généré: renew-groups-int.csv
</code></pre>

<h3>3.6 Envoi d’invitations (e-mail)</h3>
<pre><code># DRY-RUN
node -r dotenv/config scripts/email/send-renew-invites.js renew-groups-int.csv \
  --season=2025-2026 --venue=patinoire-blagnac --fromName="TBHC Billetterie" \
  --dry dotenv_config_path=.env.int

# ENVOI RÉEL
node -r dotenv/config scripts/email/send-renew-invites.js renew-groups-int.csv \
  --season=2025-2026 --venue=patinoire-blagnac --fromName="TBHC Billetterie" \
  dotenv_config_path=.env.int
</code></pre>

<h3>3.7 Clôturer la phase renew</h3>
<p>(si route admin activée)</p>
<pre><code>curl -X POST https://billetterie-dev.belougas.fr/bts/api/admin/renewal/close \
  -H "x-admin-key: &lt;SECRET&gt;"
# Attendu: { "ok": true, "released": &lt;n&gt; }
</code></pre>

<h2>4. Formats CSV (en-têtes & exemples)</h2>

<h3>4.1 Catalogue des tarifs – <code>data/tariff_catalog.csv</code></h3>
<p><strong>En-têtes :</strong> <code>code,label,active,requiresField,fieldLabel,requiresInfo,sortOrder</code></p>
<pre><code>code,label,active,requiresField,fieldLabel,requiresInfo,sortOrder
NORMAL,TARIF NORMAL,true,false,,false,10
ETUDIANT,TARIF ETUDIANT,true,true,Numéro INE,true,20
12_17,TARIF 12-17 ANS,true,false,,true,30
U12,TARIF MOINS DE 12 ANS,true,false,,true,40
LIC_MAJ,TARIF CLUB - LICENCIE MAJEUR,true,true,Numéro de licence,false,50
LIC_MIN,TARIF CLUB - LICENCIE MINEUR,true,true,Numéro de licence,false,60
PARENT,TARIF CLUB - PARENT DE LICENCIE,true,true,Numéro de licence,true,70
</code></pre>

<h3>4.2 Prix par zone – <code>data/prices_patinoire-blagnac.csv</code></h3>
<p><strong>En-têtes :</strong> <code>zoneKey,tariffCode,priceCents</code></p>
<pre><code>zoneKey,tariffCode,priceCents
N1,NORMAL,18000
N1,ETUDIANT,12600
N1,12_17,12000
N1,U12,9000
S1,NORMAL,16000
S1,ETUDIANT,11200
S1,12_17,10800
S1,U12,8000
</code></pre>

<h3>4.3 Abonnés (flat) – <code>data/subscribers_flat.csv</code></h3>
<p><strong>En-têtes :</strong> <code>groupKey,email,firstName,lastName,phone,seasonCode,venueSlug,seatId,zoneKey</code></p>
<p><em>1 ligne = 1 siège</em>. Exemple (nomenclature de siège type <code>N1-A-001</code> / <code>S1-H-012</code>) :</p>
<pre><code>groupKey,email,firstName,lastName,phone,seasonCode,venueSlug,seatId,zoneKey
alice-group,alice@example.com,Alice,Durand,0600000001,2025-2026,patinoire-blagnac,N1-A-001,N1
alice-group,alice@example.com,Alice,Durand,0600000001,2025-2026,patinoire-blagnac,N1-A-002,N1
bruno-group,bruno@example.com,Bruno,Martin,0600000002,2025-2026,patinoire-blagnac,S1-H-003,S1
</code></pre>

<h3>4.4 Liens renew (export) – <code>renew-groups-*.csv</code></h3>
<p><strong>En-têtes :</strong> <code>groupKey,email,link,seats</code> – <code>seats</code> = liste séparée par <code>;</code>.</p>
<pre><code>groupKey,email,link,seats
alice-group,alice@example.com,https://billetterie-dev.belougas.fr/bts/s/renew?id=...,N1-A-001;N1-A-002
bruno-group,bruno@example.com,https://billetterie-dev.belougas.fr/bts/s/renew?id=...,S1-H-003
</code></pre>

<h2>5. E-mails</h2>
<ul>
  <li>Test SMTP : <code>/api/admin/email/test?to=...</code> (header admin si nécessaire).</li>
  <li>Invitations : script CLI (dry-run conseillé).</li>
  <li>Attestation : envoi automatique au retour HelloAsso payé (<code>/ha/return</code>).</li>
</ul>

<h2>6. Supervision &amp; sécurité</h2>
<ul>
  <li>Logs PM2, grep erreurs HelloAsso/e-mail.</li>
  <li><code>syncIndexes</code> après migrations.</li>
  <li>Rotation des secrets, .env permissions.</li>
  <li>Mongo auth/bind 127.0.0.1.</li>
</ul>
</main>
<footer>
  <div>Licence MIT · © TBHC / Belougas</div>
</footer>
</body></html>