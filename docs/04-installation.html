---
title: Installation (DEV/INT/PROD)
nav_order: 5
---

# Installation

## Pré-requis
- Node.js 20.x, npm
- MongoDB local (DEV) + comptes dédiés INT/PROD
- Nginx (VPS), PM2
- `.env` par déploiement (un seul fichier), ex.:

MONGO_URI=mongodb://127.0.0.1:27017/bts
JWT_SECRET=une_chaine_longue
PORT=8080
APP_URL=http://localhost:8080
SELF_API_BASE=http://127.0.0.1:8080
FRONTEND_ORIGIN=http://localhost:8080
HELLOASSO_STUB=true
HELLOASSO_STUB_RESULT=success



## Installation locale (DEV)
```bash
git clone git@github.com:belou00/bts.git
cd bts
npm ci
npm run dev
# => http://localhost:8080/health

Déploiement INT/PROD (VPS)

    Dossiers séparés /var/www/bts-int, /var/www/bts-prod

    .env propre à chaque dossier (Mongo + HelloAsso sandbox/prod)

    Nginx reverse proxy (/bts → 127.0.0.1:PORT)

    PM2 :

cd /var/www/bts-int
pm2 start src/server.js --name bts-int --update-env
pm2 save

Tests progressifs

curl -s http://localhost:8080/health | jq .
curl -I http://localhost:8080/venues/patinoire-blagnac/plan.svg
curl -s http://localhost:8080/api/v1/venues | jq .


## docs/05-exploitation.md  ✅ (long — complet)
```markdown
---
title: Exploitation (Renew)
nav_order: 6
---

# Exploitation – Renouvellements (v1)

Cette procédure part d’une base propre et va jusqu’à la **génération des liens**.

> Convention : un seul fichier **.env** par déploiement (DEV/INT/PROD).

---

## 0) (optionnel) Reset DB

```bash
node scripts/admin/reset-db.js --force

1) Enregistrer le lieu + copier le plan

node scripts/venues/register-venue-with-plan.js patinoire-blagnac "Patinoire de Blagnac" src/public/venues/patinoire-blagnac/plan.svg

    Copie le SVG en src/public/venues/<slug>/plan.svg

    Enregistre le lieu en base (pour les routes publiques /venues/<slug>/plan.svg)

2) Importer les sièges depuis le SVG

    Ordre des arguments (validé) : <slug> <plan.svg>

node scripts/venues/import-seats-from-svg.js patinoire-blagnac src/public/venues/patinoire-blagnac/plan.svg
# log: "Found XXXX seats in SVG" + "Upserted XXXX seats into catalog ..."

3) Instancier les sièges pour la saison

node scripts/venues/instantiate-seats-for-season.js 2025-2026 patinoire-blagnac
# log attendu: created ~1206, skipped ~0

Vérifs :

mongosh bts --eval 'db.seats.countDocuments({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac"})'
mongosh bts --eval 'db.seats.find({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac"}).limit(5).forEach(p=>print(p.seatId))'

4) Créer / activer la saison + phase renewal

node scripts/admin/upsert-season.js 2025-2026 --name="Saison 2025-2026" --enable-renewal

5) Importer le catalogue des tarifs

data/tariff_catalog.csv :

code,label,requiresField,fieldLabel,requiresInfo,sortOrder,active
NORMAL,Tarif normal,false,,false,10,true
ETUD,Tarif étudiant,true,Numéro INE,true,20,true
12_17,12-17 ans,false,,true,30,true
U12,Moins de 12 ans,false,,true,40,true
CLUB_AD,Club - Licencié majeur,true,Numéro de licence,false,50,true
CLUB_U18,Club - Licencié mineur,true,Numéro de licence,false,60,true
CLUB_PARENT,Club - Parent de licencié,true,Numéro de licence,false,70,true

Commande :

node scripts/tariffs/import-catalog.js data/tariff_catalog.csv

6) Importer les prix par zone (saison/lieu)

data/prices_patinoire-blagnac_2025-2026.csv :

zoneKey,tariffCode,priceEuro
S1,NORMAL,180
S1,ETUD,126
S1,12_17,90
S1,U12,70
S1,CLUB_AD,120
S1,CLUB_U18,80
S1,CLUB_PARENT,120

Commande :

node scripts/pricing/import-zone-tariffs.js 2025-2026 patinoire-blagnac data/prices_patinoire-blagnac_2025-2026.csv

7) Importer les abonnés flat (1 ligne = 1 siège)

data/subscribers_flat.csv :

firstName,lastName,email,phone,seasonCode,venueSlug,seatId,group
Alice,Durand,alice@example.com,0600000001,2025-2026,patinoire-blagnac,S1-A-001,
Bob,Durand,alice@example.com,0600000001,2025-2026,patinoire-blagnac,S1-A-002,
Chloe,Martin,bruno@example.com,0600000002,2025-2026,patinoire-blagnac,N1-H-015,LesMartin

Commande :

node scripts/import-subscribers-flat.js data/subscribers_flat.csv 2025-2026 --venue=patinoire-blagnac

8) (Optionnel) Provisionner les sièges renewal

node scripts/renewal/provision-seats.js 2025-2026 --venue=patinoire-blagnac

9) Exporter les liens de renouvellement (par groupe)

node scripts/export-renew-groups.js 2025-2026 --venue=patinoire-blagnac \
  --base=http://localhost:8080 --out=renew-groups.csv

Le CSV contient : groupKey,email,seats,token,renewUrl.
10) Tester un lien

Ouvrir la colonne renewUrl (colonne 5) :

xdg-open "$(awk -F, 'NR==2{u=$5; gsub(/^\"|\"$/, "", u); print u}' renew-groups.csv)"

Tester l’API via le token (colonne 4) :

TOKEN="$(awk -F, 'NR==2{t=$4; gsub(/^\"|\"$/, "", t); print t}' renew-groups.csv)"
curl -H "Accept: application/json" "http://localhost:8080/s/renew?id=$TOKEN" | jq .

Audits & diagnostics

Nombre de sièges saison :

mongosh bts --eval 'db.seats.countDocuments({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac"})'

Tarifs actifs :

mongosh bts --eval 'db.tariffs.find({active:true}).project({code:1,label:1})'

Prix d’une zone :

mongosh bts --eval 'db.tariffprices.find({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac",zoneKey:"S1"})'

Exemple abonné :

mongosh bts --eval 'db.subscribers.findOne({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac"},{firstName:1,lastName:1,email:1,prefSeatId:1,previousSeasonSeats:1,groupKey:1})'

Provisionnés :

mongosh bts --eval 'db.seats.find({seasonCode:"2025-2026",venueSlug:"patinoire-blagnac",status:"provisioned"}).limit(5).project({seatId:1,provisionedFor:1})'

Phases saison :

mongosh bts --eval 'db.seasons.findOne({code:"2025-2026"})'


---

# 4) Publier la doc

Depuis ta branche de travail (ex: `dev`) :

```bash
git checkout dev
mkdir -p docs/assets
# (copie ton logo en docs/assets/logo.png si tu veux)
git add docs
git commit -m "Docs: site GitHub Pages (just-the-docs) + 05-exploitation complet"
git push origin dev

Puis promouvoir vers int/main (comme on a vu) :

git checkout int
git merge --ff-only dev
git push origin int

git checkout main
git merge --ff-only int
git push origin main

GitHub Pages va reconstruire automatiquement depuis main / docs et publier sous https://belou00.github.io/bts.

Si tu veux, je peux aussi te donner un petit workflow GitHub Actions pour builder la doc (mais avec Deploy from a branch → /docs, ce n’est pas obligatoire).


