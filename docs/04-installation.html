<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTS – Guide d’installation (Phase 1)</title>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#0b1020;color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:24px}
header{position:sticky;top:0;background:rgba(17,24,39,.9);border-bottom:1px solid var(--border);backdrop-filter:saturate(140%) blur(6px);}
header .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 24px}
header img{height:38px}
h1{font-size:28px;margin:18px 0 8px}
h2{font-size:22px;margin:20px 0 8px}
h3{font-size:18px;margin:18px 0 6px}
p{margin:8px 0}
ul{margin:6px 0 12px 22px}
code,kbd,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
pre{background:#0b1020;border:1px solid var(--border);border-radius:8px;padding:12px;overflow:auto;white-space:pre}
table{width:100%;border-collapse:collapse;margin:10px 0 16px}
th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
.small{color:var(--muted);font-size:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;margin:16px 0}
footer{border-top:1px solid var(--border);margin-top:24px;padding:16px 24px;color:var(--muted)}
.toc{background:#0b1020;border:1px solid var(--border);border-radius:12px;padding:12px}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
</style>
</head>
<body>
<header><div class="inner">
  <img src="logo.png" alt="Belougas" />
  <div>
    <div class="small">BelougasTicketingSystem · Phase 1 · 2025-08-17</div>
    <strong>BTS – Guide d’installation (Phase 1)</strong>
  </div>
</div></header>
<main class="container">

<div class="card"><h1>Guide d’installation</h1></div>

<h2>1. Pré-requis</h2>
<ul>
  <li>Ubuntu 22.04, Node ≥ 20, npm ≥ 10, MongoDB, Nginx, Certbot.</li>
  <li>DNS : <code>billetterie-dev.belougas.fr</code> (INT) et <code>billetterie.belougas.fr</code> (PROD) → IP VPS.</li>
</ul>

<h2>2. Vérifications de base</h2>
<pre><code>node -v           # → v20.x
npm -v            # → 10.x
mongod --version  # → &gt;= 6.x
nginx -v          # → nginx/1.2x
</code></pre>

<h2>3. Dépôts & arborescence</h2>
<pre><code>sudo mkdir -p /var/www/bts-int /var/www/bts-prod /var/log/pm2
sudo chown -R $USER:$USER /var/www

git clone git@github.com:belou00/bts.git /var/www/bts-int
cd /var/www/bts-int &amp;&amp; git checkout int &amp;&amp; npm ci --omit=dev

git clone git@github.com:belou00/bts.git /var/www/bts-prod
cd /var/www/bts-prod &amp;&amp; git checkout main &amp;&amp; npm ci --omit=dev
</code></pre>

<h2>4. MongoDB (auth + utilisateurs)</h2>
<p><strong>/etc/mongod.conf</strong> :</p>
<pre><code>security:
  authorization: enabled
net:
  bindIp: 127.0.0.1
</code></pre>
<p>Création des users :</p>
<pre><code>// INT
use bts_int
db.createUser({ user:"bts_int", pwd:"***", roles:[{role:"readWrite",db:"bts_int"}] })
// PROD
use bts_prod
db.createUser({ user:"bts_prod", pwd:"***", roles:[{role:"readWrite",db:"bts_prod"}] })
</code></pre>
<p><em>Tests attendus</em> :</p>
<pre><code>mongosh "mongodb://bts_int:&lt;PASS&gt;@127.0.0.1:27017/bts_int?authSource=bts_int" --eval 'db.runCommand({ping:1})'
# → { ok: 1 }
</code></pre>

<h2>5. Variables d’environnement (INT exemple)</h2>
<pre><code>APP_ENV=integration
PORT=8081
MONGO_URI_INT=mongodb://bts_int:&lt;PASS&gt;@127.0.0.1:27017/bts_int?authSource=bts_int
JWT_SECRET=***INT***

HELLOASSO_ENV=sandbox
HELLOASSO_ORG_SLUG=...
HELLOASSO_CLIENT_ID_SANDBOX=...
HELLOASSO_CLIENT_SECRET_SANDBOX=...
HELLOASSO_RETURN_URL_SANDBOX=https://billetterie-dev.belougas.fr/bts/ha/return
HELLOASSO_ERROR_URL_SANDBOX=https://billetterie-dev.belougas.fr/bts/ha/error
HELLOASSO_BACK_URL_SANDBOX=https://billetterie-dev.belougas.fr/bts/ha/back

APP_URL=https://billetterie-dev.belougas.fr/bts
SELF_API_BASE=http://127.0.0.1:8081
FRONTEND_ORIGIN=https://billetterie-dev.belougas.fr

GMAIL_USER=...
GMAIL_APP_PASSWORD=...
FROM_EMAIL=billetterie@tbhc.fr
</code></pre>

<h2>6. PM2 (démarrage + tests)</h2>
<pre><code>pm2 start /var/www/ecosystem.config.js --only bts-int
pm2 status
pm2 logs bts-int --lines 50
# Attendu dans les logs : "[BTS] Mongo connected", "API listening on http://localhost:8081"
</code></pre>

<h2>7. Nginx &amp; TLS</h2>
<p>Test du proxy :</p>
<pre><code>curl -s https://billetterie-dev.belougas.fr/bts/health | jq .
# Attendu: {"ok":true,"env":"integration",...}
</code></pre>
<p>Challenge ACME (si besoin) :</p>
<pre><code>sudo mkdir -p /var/www/html/.well-known/acme-challenge
echo ok | sudo tee /var/www/html/.well-known/acme-challenge/test.txt
curl -I http://billetterie-dev.belougas.fr/.well-known/acme-challenge/test.txt
# Attendu: 200 OK (ou 301→200), pas d'intercepteur tiers
</code></pre>

<h2>8. Tests fonctionnels</h2>
<pre><code># Front statique (CSS/plan)
curl -I https://billetterie-dev.belougas.fr/bts/static/styles/renew.css     # → 200
curl -I https://billetterie-dev.belougas.fr/bts/venues/patinoire-blagnac/plan.svg  # → 200

# Santé API
curl -s https://billetterie-dev.belougas.fr/bts/health | jq .

# E-mail test (adapter requireAdmin)
curl -s "https://billetterie-dev.belougas.fr/bts/api/admin/email/test?to=toi@mail.com"   -H "x-admin-key: &lt;SECRET&gt;" | jq .
</code></pre>
</main>
<footer>
  <div>Licence MIT · © TBHC / Belougas</div>
</footer>
</body></html>