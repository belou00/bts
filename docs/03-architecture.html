<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BTS – Architecture (Phase 1)</title>
<style>
:root{
  --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#94a3b8; --border:#1f2937;
  --accent:#22d3ee; --ok:#34d399; --warn:#fbbf24; --danger:#f87171;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#0b1020;color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
a{color:var(--accent);text-decoration:none}
.container{max-width:1100px;margin:0 auto;padding:24px}
header{position:sticky;top:0;background:rgba(17,24,39,.9);border-bottom:1px solid var(--border);backdrop-filter:saturate(140%) blur(6px);}
header .inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:12px 24px}
header img{height:38px}
h1{font-size:28px;margin:18px 0 8px}
h2{font-size:22px;margin:20px 0 8px}
h3{font-size:18px;margin:18px 0 6px}
p{margin:8px 0}
ul{margin:6px 0 12px 22px}
code,kbd,pre{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}
pre{background:#0b1020;border:1px solid var(--border);border-radius:8px;padding:12px;overflow:auto;white-space:pre}
table{width:100%;border-collapse:collapse;margin:10px 0 16px}
th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
.small{color:var(--muted);font-size:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px;margin:16px 0}
footer{border-top:1px solid var(--border);margin-top:24px;padding:16px 24px;color:var(--muted)}
.toc{background:#0b1020;border:1px solid var(--border);border-radius:12px;padding:12px}
hr{border:none;border-top:1px solid var(--border);margin:16px 0}
</style>
</head>
<body>
<header><div class="inner">
  <img src="logo.png" alt="Belougas" />
  <div>
    <div class="small">BelougasTicketingSystem · Phase 1 · 2025-08-17</div>
    <strong>BTS – Architecture (Phase 1)</strong>
  </div>
</div></header>
<main class="container">

<div class="card"><h1>Architecture générale</h1></div>

<h2>1. Vue d’ensemble</h2>
<ul>
  <li>API Node.js/Express (routes REST + front statique sous <code>/static</code> et <code>/venues/&lt;slug&gt;/plan.svg</code>).</li>
  <li>MongoDB : <code>Subscriber</code>, <code>Seat</code>, <code>SeatHold</code>, <code>Season</code>, <code>Tariff</code>, <code>TariffPrice</code>, <code>Counter</code>, <code>Order</code>.</li>
  <li>Paiement HelloAsso (sandbox/prod) ; attestation e-mail après retour.</li>
  <li>Infra : Nginx (TLS) + PM2 (bts-int, bts-prod) sur VPS OVH.</li>
</ul>

<h2>2. Arborescence (principale)</h2>
<pre><code>.
├── data/                         # CSV d'import/export (tarifs, prix, abonnés, liens)
├── docs/                         # Pages HTML de documentation (GitHub Pages)
├── scripts/
│   ├── docs/
│   │   └── build-docs.js         # Générateur des pages HTML (ce fichier)
│   ├── email/
│   │   └── send-renew-invites.js # Envoi d'invitations renew (CSV)
│   ├── renewal/
│   │   └── provision-seats.js    # Provision des sièges N-1 → status=provisioned
│   ├── tariffs/
│   │   └── import-catalog.js     # Import du catalogue des tarifs (codes/labels/justifs)
│   ├── pricing/
│   │   └── import-zone-tariffs.js# Import des prix par zone/saison/venue
│   ├── import-subscribers-flat.js# Import abonnés "1 ligne = 1 siège"
│   └── export-renew-groups.js    # Export des liens renew "par groupe"
├── src/
│   ├── config/
│   │   └── env.js                # Sélection des variables selon APP_ENV (dev/int/prod)
│   ├── loaders/
│   │   ├── express.js            # Création app Express, static (/static, /venues, basePath)
│   │   ├── mongo.js              # Connexion Mongo (MONGO_URI_DEV/INT/PROD)
│   │   └── mailer.js             # Nodemailer (Gmail), bascule MAIL_ENABLED
│   ├── models/
│   │   ├── Counter.js            # Compteur (séquences: subscriberNo)
│   │   ├── Order.js              # Commande (checkoutId, payer, lines, status)
│   │   ├── Seat.js               # Siège (status available/provisioned/held/booked)
│   │   ├── SeatHold.js           # Blocage temporaire (TTL index)
│   │   ├── Season.js             # Saison (code, venueSlug, phases)
│   │   ├── Subscriber.js         # Abonné (groupKey, subscriberNo, ...)
│   │   ├── Tariff.js             # Catalogue de tarifs (codes, labels, champs requis)
│   │   └── TariffPrice.js        # Prix par zone/saison/venue/tarif
│   ├── routes/
│   │   ├── index.js              # Montage des sous-routes
│   │   ├── renew.js              # GET/POST renouvellement (token → sièges, tarifs, checkout)
│   │   ├── payments-helloasso.js # POST checkout HelloAsso (intent)
│   │   ├── ha.js                 # GET /ha/return|back|error (validation + attestation e-mail)
│   │   ├── admin.js              # Admin (phases, close/open renewal, etc.)
│   │   └── admin-email.js        # Test e-mail SMTP
│   ├── services/
│   │   ├── attestation.js        # Rendu HTML de l’attestation e-mail
│   │   ├── helloasso.js          # Client HelloAsso (token, endpoints, status)
│   │   └── mailer.js             # Envoi d’e-mails (from/subject/html...)
│   ├── utils/
│   │   ├── money.js              # fmtEuros, splitInstallments...
│   │   └── pricing.js            # needJustification, computeSubscriptionPriceCents
│   ├── public/
│   │   ├── html/
│   │   │   └── renew.html        # Front Renew (HTML)
│   │   ├── styles/
│   │   │   └── renew.css         # Styles
│   │   ├── static/
│   │   │   └── img/logo.png      # Logo club
│   │   └── venues/
│   │       └── patinoire-blagnac/
│   │           └── plan.svg      # Plan SVG (ids de sièges)
│   └── server.js                 # Entrée de l'application (start Express + Mongo)
├── package.json
└── README.md
</code></pre>

<h2>3. Modèles clés (rappel)</h2>
<table>
<tr><th>Modèle</th><th>Champs principaux</th></tr>
<tr><td>Season</td><td>code, name, active, <strong>venueSlug</strong>, phases[{name,openAt,closeAt,enabled}]</td></tr>
<tr><td>Seat</td><td>seatId, zoneKey, seasonCode, venueSlug, status, provisionedFor</td></tr>
<tr><td>SeatHold</td><td>seatId, orderId, expiresAt (TTL index)</td></tr>
<tr><td>Subscriber</td><td>subscriberNo?, firstName, lastName, email, phone, group, groupKey, previousSeasonSeats, status</td></tr>
<tr><td>Tariff</td><td>code, label, active, requiresField, fieldLabel, requiresInfo, sortOrder</td></tr>
<tr><td>TariffPrice</td><td>seasonCode, venueSlug, zoneKey, tariffCode, priceCents</td></tr>
<tr><td>Counter</td><td>key, seq (numérotation abonné)</td></tr>
<tr><td>Order</td><td>seasonCode, payer, totalCents, installments, status, checkoutIntentId, haPaymentRef?, lines[{seatId,zoneKey,tariffCode,priceCents,subscriberId}]</td></tr>
</table>
</main>
<footer>
  <div>Licence MIT · © TBHC / Belougas</div>
</footer>
</body></html>